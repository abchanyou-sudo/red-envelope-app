<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#dc2626" />
  <title>紅包記帳系統</title>
  <link rel="apple-touch-icon" sizes="192x192" id="apple-192" />
  <link rel="apple-touch-icon" sizes="512x512" id="apple-512" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="紅包記帳" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    video, canvas { max-width: 100%; border-radius: .5rem; }
    .badge { padding:.1rem .5rem; border-radius:.5rem; font-size:.75rem; }
    .mono { font-family: ui-monospace, Menlo, Monaco, Consolas, 'Courier New', monospace; }
    .chip { display:inline-block; padding:.2rem .5rem; border:1px solid #eee; border-radius:.5rem; margin-right:.4rem; margin-bottom:.3rem; }
  </style>
  <script src="https://unpkg.com/tesseract.js@5.0.5/dist/tesseract.min.js"></script>
</head>
<body class="bg-white text-gray-800">
  <div id="app" class="max-w-xl mx-auto p-4 space-y-4">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold text-red-600">紅包記帳系統</h1>
      <div class="flex items-center gap-2">
        <span id="net" class="badge bg-gray-200 text-gray-600">檢查中</span>
        <span id="seq" class="badge bg-gray-100 text-gray-700">編碼：1</span>
      </div>
    </div>
    <details class="p-3 border rounded-md">
      <summary class="cursor-pointer">說明（展開）</summary>
      <ul class="text-sm text-gray-600 mt-2 list-disc pl-5 space-y-1">
        <li>繁中語言包從 jsDelivr 下載，PWA 會快取，之後離線可用。</li>
        <li>一次辨識多張紙鈔：只接受 100/200/500/1000（含中文大寫）。</li>
        <li>相機或相簿選圖；新增記錄「編碼 +1」。</li>
      </ul>
    </details>
    <div class="p-3 border rounded-lg space-y-2">
      <div class="font-semibold">相片/相機（一次多張）</div>
      <div class="flex gap-2 flex-wrap">
        <label class="px-3 py-2 rounded border cursor-pointer">
          拍照
          <input id="pickCam" type="file" accept="image/*" capture="environment" class="hidden" />
        </label>
        <label class="px-3 py-2 rounded border cursor-pointer">
          從相簿選擇
          <input id="pickLib" type="file" accept="image/*" class="hidden" />
        </label>
        <button id="openCam" class="px-3 py-2 rounded bg-red-600 text-white">開啟相機</button>
        <button id="closeCam" class="px-3 py-2 rounded border hidden">關閉相機</button>
        <button id="snap" class="px-3 py-2 rounded border">拍照（串流）並辨識</button>
      </div>
      <video id="video" playsInline muted class="w-full bg-black/5"></video>
      <canvas id="canvas" class="hidden"></canvas>
      <div id="busy" class="text-sm text-gray-500 hidden">載入/辨識中...</div>
    </div>
    <div class="p-3 border rounded-lg space-y-3">
      <div class="font-semibold">辨識結果（可手動調整）</div>
      <div id="chips" class="flex flex-wrap gap-2"></div>
      <div class="text-sm text-gray-600">共 <b id="cnt">0</b> 張；總金額 <b id="sum" class="mono">$0</b></div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="text-sm text-gray-600">名字（可選）</label>
          <input id="name" class="w-full border rounded p-2" placeholder="例如：王小明" />
        </div>
        <div class="flex items-end justify-end gap-2">
          <button id="reset" class="px-3 py-2 border rounded">重設明細</button>
          <button id="add" class="px-4 py-2 rounded bg-red-600 text-white">新增記錄</button>
        </div>
      </div>
    </div>
    <div class="flex justify-between items-center">
      <div class="font-semibold">記錄列表（儲存在本機）</div>
      <button id="export" class="px-3 py-2 rounded border">匯出 CSV</button>
    </div>
    <div id="list" class="space-y-2"></div>
  </div>
  <script>
    function detectBasePath(){
      const parts = location.pathname.split('/').filter(Boolean);
      return parts.length === 0 ? '/' : '/' + parts[0] + '/';
    }
    const basePath = detectBasePath();
    (function attachManifest(){
      const manifest = {
        name: "紅包記帳系統",
        short_name: "紅包記帳",
        start_url: basePath, scope: basePath, display: "standalone",
        background_color: "#ffffff", theme_color: "#dc2626", orientation: "portrait",
        icons: [
          { src: basePath + "icon-192.png", sizes: "192x192", type: "image/png", purpose: "any maskable" },
          { src: basePath + "icon-512.png", sizes: "512x512", type: "image/png", purpose: "any maskable" }
        ]
      };
      const url = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type:'application/json'}));
      const link = document.createElement('link'); link.rel = 'manifest'; link.href = url; document.head.appendChild(link);
      document.getElementById('apple-192').setAttribute('href', basePath + 'icon-192.png');
      document.getElementById('apple-512').setAttribute('href', basePath + 'icon-512.png');
    })();

    const STORAGE_ENTRIES = 'giftbook-entries';
    const STORAGE_SEQ = 'giftbook-seq';
    const loadEntries = () => { try { return JSON.parse(localStorage.getItem(STORAGE_ENTRIES) || '[]'); } catch { return []; } };
    const saveEntries = (arr) => localStorage.setItem(STORAGE_ENTRIES, JSON.stringify(arr));
    const loadSeq = () => { const n = parseInt(localStorage.getItem(STORAGE_SEQ) || '1', 10); return isNaN(n) ? 1 : n; };
    const saveSeq = (n) => localStorage.setItem(STORAGE_SEQ, String(n));

    const net = document.getElementById('net');
    const seqBadge = document.getElementById('seq');
    const busyEl = document.getElementById('busy');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const pickCam = document.getElementById('pickCam');
    const pickLib = document.getElementById('pickLib');
    const openCam = document.getElementById('openCam');
    const closeCam = document.getElementById('closeCam');
    const snapBtn = document.getElementById('snap');
    const chips = document.getElementById('chips');
    const nameEl = document.getElementById('name');
    const cntEl = document.getElementById('cnt');
    const sumEl = document.getElementById('sum');
    const resetBtn = document.getElementById('reset');
    const addBtn = document.getElementById('add');
    const exportBtn = document.getElementById('export');
    const listEl = document.getElementById('list');

    window.addEventListener('online', ()=> net.textContent='線上' );
    window.addEventListener('offline', ()=> net.textContent='離線' );
    net.textContent = navigator.onLine ? '線上' : '離線';

    let seq = loadSeq(); seqBadge.textContent = '編碼：' + seq;
    let entries = loadEntries();

    const ALLOWED = [100,200,500,1000];
    const CN_MAP = { "壹佰":100, "貳佰":200, "伍佰":500, "壹仟":1000, "壹百":100, "貳百":200, "伍百":500, "壹千":1000 };
    let breakdown = {100:0,200:0,500:0,1000:0};
    function renderChips(){
      chips.innerHTML = '';
      for (const v of ALLOWED){
        const wrap = document.createElement('div');
        wrap.className = 'chip';
        wrap.innerHTML = '<span class="mono">$'+v+'</span> ' +
          '<button class="ml-2 px-2 border rounded">-</button> ' +
          '<span class="mx-2">'+breakdown[v]+'</span> ' +
          '<button class="px-2 border rounded">+</button>';
        const [minus, , countEl, plus] = wrap.querySelectorAll('button,span');
        minus.addEventListener('click', ()=>{ breakdown[v] = Math.max(0, breakdown[v]-1); countEl.textContent = breakdown[v]; updateSum(); });
        plus.addEventListener('click', ()=>{ breakdown[v] += 1; countEl.textContent = breakdown[v]; updateSum(); });
        chips.appendChild(wrap);
      }
    }
    function updateSum(){
      const total = breakdown[100]*100 + breakdown[200]*200 + breakdown[500]*500 + breakdown[1000]*1000;
      const count = breakdown[100] + breakdown[200] + breakdown[500] + breakdown[1000];
      cntEl.textContent = count; sumEl.textContent = '$' + total;
    }
    function resetBreakdown(){ breakdown = {100:0,200:0,500:0,1000:0}; renderChips(); updateSum(); }
    renderChips(); updateSum();

    let stream = null;
    async function openCamera(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }, audio:false });
        video.srcObject = stream; await video.play(); openCam.classList.add('hidden'); closeCam.classList.remove('hidden');
      }catch(e){ alert('相機開啟失敗：' + e.message); }
    }
    function closeCamera(){ stream?.getTracks().forEach(t=>t.stop()); video.srcObject=null; openCam.classList.remove('hidden'); closeCam.classList.add('hidden'); }
    function snap(){
      if(!video.videoWidth) return null;
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video,0,0);
      return canvas.toDataURL('image/png');
    }
    openCam.addEventListener('click', openCamera);
    closeCam.addEventListener('click', closeCamera);
    snapBtn.addEventListener('click', async ()=>{
      const dataUrl = snap();
      if(!dataUrl) return alert('相機未就緒');
      await run(dataUrl);
    });
    pickCam.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const r = new FileReader(); r.onload = async ()=>{ await run(r.result); }; r.readAsDataURL(f); e.target.value='';
    });
    pickLib.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const r = new FileReader(); r.onload = async ()=>{ await run(r.result); }; r.readAsDataURL(f); e.target.value='';
    });

    const TESS_LANG_CDN = 'https://cdn.jsdelivr.net/gh/tesseract-ocr/tessdata@main';
    let worker = null;
    async function ensureWorker(){
      if (worker) return worker;
      worker = Tesseract.createWorker({ langPath: TESS_LANG_CDN, gzip:false });
      await worker.load();
      await worker.loadLanguage('chi_tra');
      await worker.initialize('chi_tra');
      return worker;
    }
    function extractAll(text){
      const found=[];
      for (const [k,v] of Object.entries(CN_MAP)){
        const re=new RegExp(k,'g'); const m=text.match(re); if(m) for(let i=0;i<m.length;i++) found.push(v);
      }
      let cleaned = text.replace(/[,\s]/g,'').replace(/NTD|TWD|NT|\$|元|圓|塊|元整/g,'').replace(/[Oo]/g,'0').replace(/[Il]/g,'1');
      const m2 = cleaned.match(/\d{3,4}/g) || [];
      for(const t of m2){ const n=parseInt(t,10); if(ALLOWED.includes(n)) found.push(n); }
      return found;
    }
    function busy(v){ busyEl.classList.toggle('hidden', !v); }

    async function run(dataUrl){
      busy(true);
      try {
        const w = await ensureWorker();
        await w.setParameters({ tessedit_char_whitelist:'0123456789', tessedit_pageseg_mode:'6' });
        const r1 = await w.recognize(dataUrl);
        await w.setParameters({ tessedit_char_whitelist:'', tessedit_pageseg_mode:'6' });
        const r2 = await w.recognize(dataUrl);
        const text = (r1.data.text||'') + '\n' + (r2.data.text||'');

        const all = extractAll(text);
        resetBreakdown();
        for (const v of all) breakdown[v]++;
        if (all.length===0) alert('未偵測到面額，請調整拍攝距離與光線。');
        renderChips(); updateSum();
      } catch (e) {
        alert('辨識失敗：' + e.message);
      } finally {
        busy(false);
      }
    }

    function renderList(){
      listEl.innerHTML = '';
      if (entries.length === 0){
        const p = document.createElement('div'); p.className='text-sm text-gray-500'; p.textContent='目前尚無資料'; listEl.appendChild(p); return;
      }
      for (const e of entries){
        const div = document.createElement('div'); div.className='p-3 border rounded-md';
        div.innerHTML = `<div class="flex items-center justify-between">
          <div class="font-medium">#${e.code} · ${e.name || '（未填名）'} · 總額 <span class="mono">$${e.total}</span></div>
          <button class="text-sm text-red-600">刪除</button>
        </div>
        <div class="text-xs text-gray-500">${new Date(e.dateISO).toLocaleString()}</div>
        <div class="text-xs text-gray-600 mt-1">明細：$100×${e.c100}、$200×${e.c200}、$500×${e.c500}、$1000×${e.c1000}</div>`;
        div.querySelector('button').addEventListener('click', ()=>{
          entries = entries.filter(x=>x.id!==e.id); saveEntries(entries); renderList();
        });
        listEl.appendChild(div);
      }
    }
    renderList();

    addBtn.addEventListener('click', ()=>{
      const total = breakdown[100]*100 + breakdown[200]*200 + breakdown[500]*500 + breakdown[1000]*1000;
      if (total === 0){ alert('尚未辨識到任何面額'); return; }
      const now = new Date();
      const entry = {
        id: now.getTime(), dateISO: now.toISOString(), code: seq, name: nameEl.value || '',
        total, c100:breakdown[100], c200:breakdown[200], c500:breakdown[500], c1000:breakdown[1000]
      };
      entries = [entry, ...entries]; saveEntries(entries); renderList();
      seq += 1; saveSeq(seq); seqBadge.textContent = '編碼：' + seq;
      nameEl.value=''; resetBreakdown();
    });

    exportBtn.addEventListener('click', ()=>{
      const header = ['日期','編碼','名字','總張數','總金額','100張','200張','500張','1000張'];
      const rows = entries.map(e => [
        new Date(e.dateISO).toLocaleString(),
        e.code, e.name || '', (e.c100+e.c200+e.c500+e.c1000),
        e.total, e.c100, e.c200, e.c500, e.c1000
      ]);
      const csv = [header, ...rows].map(r => r.map(x => `"${(x??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
      const url = URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8;'}));
      const a = Object.assign(document.createElement('a'), { href:url, download:`giftbook_${new Date().toISOString().slice(0,10)}.csv` });
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    });

    if ('serviceWorker' in navigator){
      navigator.serviceWorker.register(basePath + 'service-worker.js', { scope: basePath });
    }
  </script>
</body>
</html>
